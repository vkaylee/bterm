<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTerminal</title>
    <script src="./assets/tailwindcss.js"></script>
    <link rel="stylesheet" href="./assets/xterm.css" />
    <script src="./assets/xterm.js"></script>
    <script src="./assets/xterm-addon-fit.js"></script>
    <style>
        @font-face {
            font-family: 'JetBrains Mono';
            src: url('./assets/fonts/JetBrainsMono-Regular.ttf') format('truetype');
        }
        body { 
            background-color: #020617; 
            color: white; 
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
        }
        .xterm-viewport { overflow-y: auto !important; }
        #terminal { background-color: black; }
        /* Style cho các nút điều khiển trên mobile */
        .btn-ctrl {
            background-color: #334155;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            min-width: 44px;
            text-align: center;
        }
        .btn-ctrl:active { background-color: #475569; }
    </style>
</head>
<body class="overflow-hidden">
    <div id="app" class="flex flex-col h-[100dvh] w-screen">
        <!-- Header -->
        <header class="flex justify-between items-center px-4 py-3 bg-slate-900 border-b border-slate-800 shadow-md z-10">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-blue-400 tracking-tight">BTerminal</h1>
                <div id="session-info" class="hidden items-center gap-3 border-l border-slate-700 pl-4">
                    <span class="text-gray-400 text-sm">Session:</span>
                    <span id="current-session-id" class="text-blue-300 font-medium"></span>
                    <button onclick="backToDashboard()" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded text-xs border border-slate-700 transition">Exit</button>
                </div>
            </div>
            <div class="text-[10px] text-gray-500 uppercase tracking-widest">v1.1.0</div>
        </header>

        <!-- Dashboard -->
        <main id="dashboard" class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-950">
            <div class="max-w-4xl mx-auto">
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-xl mb-8">
                    <h2 class="text-lg font-semibold mb-4 text-gray-200">Create New Session</h2>
                    <div class="flex flex-col gap-3 sm:flex-row">
                        <input type="text" id="new-session-name" placeholder="Enter session name..." 
                               class="bg-slate-950 border border-slate-700 rounded-lg px-4 py-2.5 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-500 transition text-gray-200">
                        <button onclick="createSession()" class="bg-blue-600 hover:bg-blue-700 px-8 py-2.5 rounded-lg font-bold transition shadow-lg">Create</button>
                    </div>
                </div>

                <h2 class="text-lg font-semibold mb-4 text-gray-400 px-2">Active Sessions</h2>
                <div id="session-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Sessions list -->
                </div>
            </div>
        </main>

        <!-- Terminal View -->
        <div id="terminal-view" class="hidden flex-1 flex-col bg-black relative w-full overflow-hidden">
            <div id="terminal" class="flex-1 w-full h-full overflow-hidden"></div>
            
            <!-- Mobile Controls -->
            <div id="control-bar" class="hidden flex-wrap justify-center gap-1.5 p-2 bg-slate-900 border-t border-slate-800">
                <button class="btn-ctrl" onclick="sendSpecialKey('control')">Ctrl</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('alt')">Alt</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('escape')">Esc</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('tab')">Tab</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('arrowup')">▲</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('arrowdown')">▼</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('arrowleft')">◀</button>
                <button class="btn-ctrl" onclick="sendSpecialKey('arrowright')">▶</button>
            </div>
        </div>
    </div>

    <script>
        let term, fitAddon, ws;

        // Expose to window for E2E tests
        window.term = null;
        window.fitAddon = null;
        window.ws = null;

        const resizeObserver = new ResizeObserver(() => {
            if (term && fitAddon && document.getElementById('terminal-view').style.display === 'flex') {
                requestAnimationFrame(() => {
                    try {
                        fitAddon.fit();
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: 'Resize', data: { rows: term.rows, cols: term.cols } }));
                        }
                    } catch (e) {}
                });
            }
        });

        async function fetchSessions() {
            try {
                const res = await fetch('/api/sessions');
                const sessions = await res.json();
                const list = document.getElementById('session-list');
                list.innerHTML = '';
                
                if (sessions.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 italic px-2">No active sessions.</p>';
                    return;
                }

                sessions.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'group relative bg-slate-800 p-5 rounded-lg border border-slate-700 hover:border-blue-500 cursor-pointer transition shadow-md';
                    card.onclick = () => joinSession(s.id);
                    card.innerHTML = `
                        <div class="font-mono text-lg font-bold mb-1">${s.id}</div>
                        <div class="text-xs text-gray-500">Connect to session</div>
                        <button onclick="event.stopPropagation(); removeSession('${s.id}')" 
                                class="absolute top-4 right-4 p-2 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                    list.appendChild(card);
                });
            } catch (e) { console.error("Fetch sessions failed", e); }
        }

        async function createSession() {
            const input = document.getElementById('new-session-name');
            const id = input.value.trim();
            if (!id) return;
            
            console.log("Creating session:", id);
            try {
                const res = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    input.value = '';
                    fetchSessions();
                } else {
                    alert('Error: Session ID might already exist.');
                }
            } catch (e) {
                console.error("Create session failed", e);
                alert("Network error. Is the server running?");
            }
        }

        async function removeSession(id) {
            if (!confirm(`Are you sure you want to delete session "${id}"?`)) return;
            try {
                const res = await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
                if (res.ok) fetchSessions();
            } catch (e) { console.error(e); }
        }

        function joinSession(id) {
            document.getElementById('dashboard').classList.add('hidden');
            const view = document.getElementById('terminal-view');
            view.style.display = 'flex';
            document.getElementById('session-info').classList.remove('hidden');
            document.getElementById('current-session-id').innerText = id;
            
            if (window.innerWidth <= 768) {
                document.getElementById('control-bar').style.display = 'flex';
            }

            if (term) term.dispose();
            const container = document.getElementById('terminal');
            container.innerHTML = '';
            
            term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: '"JetBrains Mono", monospace',
                theme: { 
                    background: '#000000', 
                    foreground: '#e2e8f0', 
                    cursor: '#ffffff',
                    selectionBackground: 'rgba(255, 255, 255, 0.3)'
                },
                allowProposedApi: true,
                letterSpacing: 0.5,
                lineHeight: 1.2,
                cursorStyle: 'block'
            });
            window.term = term;
            
            fitAddon = new FitAddon.FitAddon();
            window.fitAddon = fitAddon;

            term.loadAddon(fitAddon);
            term.open(container);
            
            // Đảm bảo terminal chiếm toàn bộ không gian
            const doFit = () => {
                if (!term || !fitAddon || !container.offsetParent) return;
                try { 
                    fitAddon.fit(); 
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'Resize', data: { rows: term.rows, cols: term.cols } }));
                    }
                } catch(e) {
                    console.warn("Fit failed", e);
                }
            };

            setTimeout(doFit, 50);
            setTimeout(doFit, 300);

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/${id}`);
            window.ws = ws;
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => { doFit(); };
            ws.onmessage = (e) => { term.write(new Uint8Array(e.data)); };
            ws.onerror = (err) => { console.error("WS Error", err); };
            
            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'Input', data: data }));
                }
            });

            resizeObserver.observe(view);
            term.focus();
        }

        function sendSpecialKey(key) {
            let data;
            switch (key) {
                case 'control': data = '\x02'; break;
                case 'alt': data = '\x1b'; break;
                case 'escape': data = '\x1b'; break;
                case 'tab': data = '\t'; break;
                case 'arrowup': data = '\x1b[A'; break;
                case 'arrowdown': data = '\x1b[B'; break;
                case 'arrowleft': data = '\x1b[D'; break;
                case 'arrowright': data = '\x1b[C'; break;
            }
            if (data && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'Input', data: data }));
            }
        }

        function backToDashboard() {
            if (ws) { ws.close(); ws = null; }
            resizeObserver.disconnect();
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('terminal-view').style.display = 'none';
            document.getElementById('session-info').classList.add('hidden');
            document.getElementById('control-bar').style.display = 'none';
            fetchSessions();
        }

        fetchSessions();
    </script>
</body>
</html>
