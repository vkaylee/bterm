<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTerminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <style>
        body { background-color: #0f172a; color: white; }
        .terminal-container { height: calc(100vh - 120px); }
        #terminal { height: 100%; }
        .xterm-viewport { overflow-y: auto !important; }
        .xterm .xterm-screen {
            width: 100% !important;
            height: 100% !important;
        }
        /* Mobile specific styles for the control bar */
        @media (max-width: 768px) {
            #control-bar {
                display: flex; /* Show on mobile */
            }
        }
    </style>
</head>
<body class="p-0 m-0 overflow-hidden bg-slate-950 text-white">
    <div id="app" class="flex flex-col h-screen">
        <header class="flex justify-between items-center px-4 py-2 bg-slate-900 border-b border-slate-800 shadow-sm md:px-6 md:py-3">
            <div class="flex items-center gap-2 md:gap-4">
                <h1 class="text-lg font-bold text-blue-400 tracking-tight md:text-xl">BTerminal</h1>
                <div id="session-info" class="hidden items-center gap-2 text-xs border-l border-slate-700 pl-2 md:flex md:gap-3 md:text-sm md:pl-4">
                    <span class="text-gray-400">Session:</span>
                    <span id="current-session-id" class="text-blue-300 font-mono font-medium"></span>
                    <button onclick="backToDashboard()" class="ml-1 px-2 py-0.5 bg-slate-800 hover:bg-slate-700 rounded text-xs transition border border-slate-700 md:ml-2 md:px-3 md:py-1">Exit</button>
                </div>
            </div>
            <div class="text-[8px] text-gray-500 font-mono uppercase tracking-widest md:text-[10px]">v1.0.0</div>
        </header>

        <!-- Dashboard -->
        <div id="dashboard" class="flex-1 overflow-y-auto p-4 md:p-10">
            <div class="max-w-4xl mx-auto">
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-2xl mb-8 md:p-8 md:mb-10">
                    <h2 class="text-base font-semibold mb-3 text-gray-200 md:text-lg">Create New Session</h2>
                    <div class="flex flex-col gap-3 md:flex-row">
                        <input type="text" id="new-session-name" placeholder="Give your session a name..." 
                               class="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition text-gray-200 md:px-4 md:py-2.5">
                        <button onclick="createSession()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition shadow-lg shadow-blue-900/20 md:px-8 md:py-2.5">Create</button>
                    </div>
                </div>

                <h2 class="text-base font-semibold mb-3 text-gray-400 px-2 md:text-lg">Active Sessions</h2>
                <div id="session-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Sessions listed here -->
                </div>
            </div>
        </div>

        <!-- Terminal View -->
        <div id="terminal-view" class="hidden flex-col flex-1 bg-black">
            <div id="terminal" class="h-full w-full"></div>
            <!-- On-screen Control Bar for Mobile -->
            <div id="control-bar" class="hidden flex-wrap justify-center gap-1 p-2 bg-slate-900 border-t border-slate-800 md:hidden">
                <button class="control-button" data-key="control">Ctrl</button>
                <button class="control-button" data-key="alt">Alt</button>
                <button class="control-button" data-key="escape">Esc</button>
                <button class="control-button" data-key="tab">Tab</button>
                <button class="control-button" data-key="arrowup">▲</button>
                <button class="control-button" data-key="arrowdown">▼</button>
                <button class="control-button" data-key="arrowleft">◀</button>
                <button class="control-button" data-key="arrowright">▶</button>
                <!-- Add more special keys as needed -->
            </div>
        </div>
    </div>

    <script>
        let term;
        let fitAddon;
        let ws;

        // Tối ưu hóa việc resize
        const resizeObserver = new ResizeObserver(() => {
            if (fitAddon && term) {
                fitAddon.fit();
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'Resize', data: { rows: term.rows, cols: term.cols } }));
                }
            }
        });

        async function fetchSessions() {
            console.log('Fetching sessions...');
            const res = await fetch('/api/sessions');
            const sessions = await res.json();
            console.log('Fetched sessions:', sessions);
            const list = document.getElementById('session-list');
            list.innerHTML = '';
            
            if (sessions.length === 0) {
                list.innerHTML = '<p class="text-gray-500 italic">No active sessions.</p>';
                return;
            }

            sessions.forEach(s => {
                const card = document.createElement('div');
                card.className = 'group relative bg-slate-800 p-4 rounded-lg border border-slate-700 hover:border-blue-500 cursor-pointer transition';
                card.onclick = () => joinSession(s.id);
                card.innerHTML = `
                    <div class="font-mono text-lg mb-2">${s.id}</div>
                    <div class="text-xs text-gray-400">Click to connect</div>
                    <button onclick="event.stopPropagation(); removeSession('${s.id}')" 
                            class="absolute top-3 right-3 p-2 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                list.appendChild(card);
            });
        }

        async function removeSession(id) {
            if (!confirm(`Are you sure you want to delete session "${id}"?`)) return;
            
            const res = await fetch(`/api/sessions/${id}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                fetchSessions();
            } else {
                alert('Failed to delete session');
            }
        }

        async function createSession() {
            const id = document.getElementById('new-session-name').value.trim();
            if (!id) return;
            
            const res = await fetch('/api/sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            
            if (res.ok) {
                document.getElementById('new-session-name').value = '';
                fetchSessions();
            } else {
                alert('Failed to create session');
            }
        }

        function joinSession(id) {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('terminal-view').classList.remove('hidden');
            document.getElementById('session-info').classList.remove('hidden');
            document.getElementById('current-session-id').innerText = id;
            
            // Show control bar on mobile devices
            if (window.innerWidth <= 768) { // Or whatever breakpoint you consider 'mobile'
                document.getElementById('control-bar').classList.remove('hidden');
            }

            if (term) term.dispose();
            const terminalContainer = document.getElementById('terminal');
            terminalContainer.innerHTML = ''; // Clear container
            
            term = new Terminal({
                cursorBlink: true,
                fontSize: 16,
                fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',
                theme: {
                    background: '#000000',
                    foreground: '#e2e8f0'
                },
                allowProposedApi: true
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(terminalContainer);
            term.focus();
            
            // Expose term globally for Playwright E2E tests
            window.term = term;
            
            // Wait a bit for the element to be visible before fitting
            setTimeout(() => {
                console.log('Attempting to fit terminal after delay. Container offsetWidth:', terminalContainer.offsetWidth);
                fitAddon.fit();
                term.refresh(0, term.rows - 1);
                console.log('Terminal fitted. Rows:', term.rows, 'Cols:', term.cols);
                
                // Add a small test write to confirm rendering
                term.write('\r\n\x1b[32mBTerminal connected.\x1b[0m\r\n');
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${window.location.host}/ws/${id}`);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    console.log('WebSocket opened.');
                    // Re-fit after a short delay once WS is open to ensure rendering
                    setTimeout(() => {
                        fitAddon.fit();
                        term.refresh(0, term.rows - 1);
                        ws.send(JSON.stringify({ type: 'Resize', data: { rows: term.rows, cols: term.cols } }));
                    }, 100);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    alert('WebSocket connection error. See console for details.');
                };

                ws.onmessage = (event) => {
                    console.log('Received data from WS. Size:', event.data.byteLength);
                    term.write(new Uint8Array(event.data));
                    if (window.innerWidth <= 768) {
                        term.scrollToBottom();
                    }
                };

                term.onData(data => {
                    console.log('Term.onData fired. Data size:', data.length);
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'Input', data: data }));
                    }
                });

                resizeObserver.observe(document.getElementById('terminal-view'));

                // Attach event listeners for control buttons
                document.querySelectorAll('.control-button').forEach(button => {
                    button.onclick = () => {
                        const key = button.dataset.key;
                        let dataToSend;
                        switch (key) {
                            case 'control': dataToSend = '\x02'; break; // Ctrl+B for tmux, or other common Ctrl codes
                            case 'alt': dataToSend = '\x1b'; break; // ESC for Alt
                            case 'escape': dataToSend = '\x1b'; break;
                            case 'tab': dataToSend = '\t'; break;
                            case 'arrowup': dataToSend = '\x1b[A'; break;
                            case 'arrowdown': dataToSend = '\x1b[B'; break;
                            case 'arrowleft': dataToSend = '\x1b[D'; break;
                            case 'arrowright': dataToSend = '\x1b[C'; break;
                            default: return;
                        }
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: 'Input', data: dataToSend }));
                        }
                    };
                });

            }, 200); // Increased delay
        }

        function backToDashboard() {
            if (ws) {
                ws.close();
                ws = null; // Clear WebSocket instance
            }
            resizeObserver.unobserve(document.getElementById('terminal-view'));
            
            // Clear all event listeners for control buttons to prevent duplicates
            document.querySelectorAll('.control-button').forEach(button => {
                button.onclick = null;
            });

            // Hide control bar
            document.getElementById('control-bar').classList.add('hidden');

            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('terminal-view').classList.add('hidden');
            document.getElementById('session-info').classList.add('hidden');
            fetchSessions();
        }

        // Initial fetch of sessions when the page loads
        fetchSessions();
    </script>
    <style>
        .control-button {
            @apply bg-slate-700 hover:bg-slate-600 active:bg-slate-500 text-gray-200 text-sm font-semibold 
                   px-3 py-1 rounded-md transition duration-150 ease-in-out cursor-pointer select-none;
            min-width: 40px;
        }
    </style>
</body>
</html>
